name: Update Tor Relay List

on:
  schedule:
    - cron: "0 * * * *"  
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Fetch Tor relay list
        run: |
          python - <<'PY'
          import json
          import urllib.request

          URL = "https://onionoo.torproject.org/details?type=relay&running=true"

          with urllib.request.urlopen(URL, timeout=30) as r:
              data = json.loads(r.read().decode())

          lines = []
          for relay in data.get("relays", []):
              fingerprint = relay.get("fingerprint", "")
              nickname = relay.get("nickname", "")
              address = relay.get("or_addresses", [""])[0]
              country = relay.get("country", "")
              bw = relay.get("observed_bandwidth", 0)

              lines.append(f"{fingerprint} | {nickname} | {address} | {country} | {bw}")

          with open("relays.txt", "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          PY

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add relays.txt
          git commit -m "Update Tor relay list" || exit 0
          git push
